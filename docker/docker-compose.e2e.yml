# For parallel E2E runs, set COMPOSE_PROJECT_NAME to isolate instances:
# COMPOSE_PROJECT_NAME=eval-a docker compose -f docker/docker-compose.e2e.yml up -d
# COMPOSE_PROJECT_NAME=eval-b docker compose -f docker/docker-compose.e2e.yml up -d
#
# Discover dynamically assigned ports:
# docker compose -f docker/docker-compose.e2e.yml port spoketowork 3000

services:
  # Main application service
  spoketowork:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: dev
    ports:
      - '0:3000'   # Dev server – dynamic host port
      - '0:6006'   # Storybook
      - '0:24678'  # Next.js HMR websocket
    volumes:
      - ..:/app
      - /app/node_modules
      - /app/.next
    environment:
      - WATCHPACK_POLLING=true
      - CHOKIDAR_USEPOLLING=true
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/SpokeToWork']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - e2e-network

  # E2E testing service with Playwright
  e2e-tests:
    build:
      context: ..
      dockerfile: docker/Dockerfile.e2e
    depends_on:
      spoketowork:
        condition: service_healthy
    volumes:
      - ../tests/e2e:/app/tests/e2e
      - ../test-results:/app/test-results
      - ../playwright-report:/app/playwright-report
    environment:
      - BASE_URL=http://spoketowork:3000/SpokeToWork
      - CI=false
      - PWDEBUG=${PWDEBUG:-0}
    networks:
      - e2e-network
    command: pnpm test:e2e

  # Optional: Playwright UI mode service
  e2e-ui:
    build:
      context: ..
      dockerfile: docker/Dockerfile.e2e
    depends_on:
      spoketowork:
        condition: service_healthy
    ports:
      - '0:9323'    # Playwright UI – dynamic host port
    volumes:
      - ../tests/e2e:/app/tests/e2e
      - ../test-results:/app/test-results
      - ../playwright-report:/app/playwright-report
    environment:
      - BASE_URL=http://spoketowork:3000/SpokeToWork
      - DISPLAY=:99
    networks:
      - e2e-network
    command: pnpm test:e2e:ui
    profiles:
      - ui

networks:
  e2e-network:
    driver: bridge

volumes:
  test-results:
  playwright-report:
