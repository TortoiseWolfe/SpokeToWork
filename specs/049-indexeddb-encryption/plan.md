# Implementation Plan: Password Change Key Rotation

**Branch**: `049-indexeddb-encryption` | **Date**: 2025-12-21 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/049-indexeddb-encryption/spec.md`

## Summary

Add "Current Password" field to password change form and trigger `keyManagementService.rotateKeys()` before updating Supabase password. This ensures encryption keys remain valid after password changes.

**Scope Reduction**: Original spec assumed private keys were stored in IndexedDB. Investigation revealed keys are already derived in-memory only. The remaining work is limited to the password change flow in `AccountSettings.tsx`.

## Technical Context

**Language/Version**: TypeScript 5.x with React 19, Next.js 15
**Primary Dependencies**: Supabase Auth, existing KeyManagementService
**Storage**: Supabase (salt + public key), memory only (derived keys)
**Testing**: Vitest (unit), existing AccountSettings tests
**Target Platform**: Web (PWA)
**Project Type**: Web application (existing codebase)
**Performance Goals**: Password change <2s including key rotation
**Constraints**: Must not break existing message encryption/decryption
**Scale/Scope**: Single component modification (AccountSettings.tsx)

## Constitution Check

_GATE: Pass - changes are minimal and isolated_

| Principle                | Status                                      |
| ------------------------ | ------------------------------------------- |
| Docker-first development | ✅ Using existing Docker workflow           |
| Component structure      | ✅ Modifying existing component             |
| Security patterns        | ✅ Enhances key rotation on password change |
| No technical debt        | ✅ Fixes silent key invalidation bug        |

## Project Structure

### Documentation (this feature)

```text
specs/049-indexeddb-encryption/
├── spec.md              # Updated spec (scope corrected)
├── plan.md              # This file
└── tasks.md             # To be generated by /speckit.tasks
```

### Source Code (files to modify)

```text
src/
└── components/
    └── auth/
        └── AccountSettings/
            ├── AccountSettings.tsx        # PRIMARY: Add current password, key rotation
            └── AccountSettings.test.tsx   # Add tests for key rotation flow
```

### Existing Infrastructure (no changes needed)

```text
src/
├── services/
│   └── messaging/
│       └── key-service.ts           # rotateKeys() already exists
├── lib/
│   └── messaging/
│       └── key-derivation.ts        # Argon2id derivation already works
└── contexts/
    └── AuthContext.tsx              # Keys cleared on logout already
```

## Implementation Phases

### Phase 1: UI Enhancement (AccountSettings.tsx)

**File**: `src/components/auth/AccountSettings/AccountSettings.tsx`

1. Add state for current password:

   ```typescript
   const [currentPassword, setCurrentPassword] = useState('');
   ```

2. Add input field before "New Password":
   ```tsx
   <div className="form-control">
     <label htmlFor="current-password-input" className="label">
       <span className="label-text">Current Password</span>
     </label>
     <input
       id="current-password-input"
       type="password"
       value={currentPassword}
       onChange={(e) => setCurrentPassword(e.target.value)}
       className="input input-bordered min-h-11"
       disabled={loading}
       required
     />
   </div>
   ```

### Phase 2: Key Rotation Logic

**File**: `src/components/auth/AccountSettings/AccountSettings.tsx`

1. Import key management:

   ```typescript
   import { keyManagementService } from '@/services/messaging/key-service';
   import { KeyMismatchError, ConnectionError } from '@/types/messaging';
   ```

2. Update `handleChangePassword`:

   ```typescript
   const handleChangePassword = async (e: React.FormEvent) => {
     e.preventDefault();
     setPasswordError(null);
     setPasswordSuccess(false);

     // Validate new password
     const passwordValidation = validatePassword(password);
     if (!passwordValidation.valid) {
       setPasswordError(passwordValidation.error);
       return;
     }

     if (password !== confirmPassword) {
       setPasswordError('Passwords do not match');
       return;
     }

     if (!currentPassword) {
       setPasswordError('Current password is required');
       return;
     }

     setLoading(true);

     try {
       // Step 1: Verify current password by deriving keys
       await keyManagementService.deriveKeys(currentPassword);

       // Step 2: Rotate keys with new password
       await keyManagementService.rotateKeys(password);

       // Step 3: Update Supabase auth password
       const { error: updateError } = await supabase.auth.updateUser({
         password,
       });

       if (updateError) {
         throw updateError;
       }

       // Success
       if (user) {
         await logAuthEvent({
           user_id: user.id,
           event_type: 'password_change',
         });
       }

       setPasswordSuccess(true);
       setPassword('');
       setConfirmPassword('');
       setCurrentPassword('');
       setTimeout(() => setPasswordSuccess(false), 3000);
     } catch (error) {
       // Handle specific error types
       if (error instanceof KeyMismatchError) {
         setPasswordError('Current password is incorrect');
       } else if (error instanceof ConnectionError) {
         setPasswordError(
           'Failed to update encryption keys. Please try again.'
         );
       } else {
         const err = error as Error;
         setPasswordError(err.message || 'Failed to change password');

         if (user) {
           await logAuthEvent({
             user_id: user.id,
             event_type: 'password_change',
             success: false,
             error_message: err.message,
           });
         }
       }
     } finally {
       setLoading(false);
     }
   };
   ```

### Phase 3: Testing

**File**: `src/components/auth/AccountSettings/AccountSettings.test.tsx`

Add tests for:

1. Current password field is rendered
2. Empty current password shows error
3. Wrong current password shows "Current password is incorrect"
4. Key rotation failure aborts password change
5. Successful password change clears all fields

## Error Handling Matrix

| Error                     | User Message                       | Action                           |
| ------------------------- | ---------------------------------- | -------------------------------- |
| Empty current password    | "Current password is required"     | Block submission                 |
| KeyMismatchError          | "Current password is incorrect"    | Show error, retain fields        |
| ConnectionError           | "Failed to update encryption keys" | Show error, allow retry          |
| Supabase updateUser error | Show error.message                 | Show error, keys already rotated |

## Rollback Plan

If key rotation succeeds but `updateUser` fails:

- Keys are rotated with new password
- Supabase still has old password
- User can retry with same new password
- Or sign out and sign back in (keys will re-derive)

## Complexity Tracking

| Aspect           | Complexity | Notes                     |
| ---------------- | ---------- | ------------------------- |
| Files changed    | 1          | AccountSettings.tsx only  |
| New dependencies | 0          | Uses existing key-service |
| Database changes | 0          | Uses existing schema      |
| Breaking changes | 0          | Additive UX change only   |

**Total Effort**: ~2-3 hours implementation + testing
