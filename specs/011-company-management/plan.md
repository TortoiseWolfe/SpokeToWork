# Implementation Plan: Company Management

**Branch**: `011-company-management` | **Date**: 2025-12-04 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/011-company-management/spec.md`

## Summary

Implement a company tracking system for job seekers to manage companies they intend to visit. The system provides CRUD operations with offline-first architecture (IndexedDB + Supabase sync), automatic geocoding via Nominatim, bulk import/export (CSV/JSON), and distance validation from user's home location.

## Technical Context

**Language/Version**: TypeScript 5.x (strict mode)
**Primary Dependencies**: Next.js 15, React 19, Supabase, DaisyUI
**Storage**: Supabase (PostgreSQL) + IndexedDB (offline)
**Testing**: Vitest (unit), Playwright (E2E), Pa11y (a11y)
**Target Platform**: Static export to GitHub Pages (PWA)
**Project Type**: Web application (Next.js App Router)
**Performance Goals**: <60s to add company, <10s to find in 100+ records
**Constraints**: No server-side code, 1 req/sec geocoding rate limit, offline-capable

## Constitution Check

| Principle                  | Status      | Notes                               |
| -------------------------- | ----------- | ----------------------------------- |
| I. Component Structure     | ✅ Pass     | Use generator for 5-file pattern    |
| II. Test-First             | ✅ Pass     | Tests written before implementation |
| III. PRP Methodology       | ✅ Pass     | Full SpecKit workflow followed      |
| IV. Docker-First           | ✅ Pass     | All commands via Docker             |
| V. Progressive Enhancement | ✅ Pass     | PWA offline support                 |
| VI. Privacy & Compliance   | ✅ Pass     | RLS user isolation                  |
| VII. Company Tracking      | ✅ Pass     | Full entity per spec                |
| VIII. Geographic Accuracy  | ✅ Pass     | Manual entry + validation           |
| IX. Route Clusters         | ✅ Deferred | route_id field for future           |
| X. Bicycle Routing         | ✅ Deferred | Future feature                      |
| XI. Multi-Format Export    | ✅ Pass     | CSV + JSON                          |
| XII. Field Operations      | ✅ Pass     | IndexedDB offline                   |

## Project Structure

### Documentation (this feature)

```
specs/011-company-management/
├── spec.md              # Feature specification (complete)
├── research.md          # Phase 0 research (complete)
├── data-model.md        # Database schema (complete)
├── contracts/           # API contracts (complete)
│   ├── company-service.md
│   ├── geocoding.md
│   └── offline-sync.md
├── quickstart.md        # Implementation guide (complete)
├── plan.md              # This file
└── tasks.md             # Generated by /tasks
```

### Source Code

```
src/
├── types/
│   └── company.ts              # Type definitions
├── lib/
│   └── companies/
│       ├── index.ts            # Barrel export
│       ├── geocoding.ts        # Nominatim API client
│       ├── geocoding.test.ts
│       ├── offline-sync.ts     # IndexedDB + sync queue
│       ├── offline-sync.test.ts
│       ├── company-service.ts  # Business logic
│       └── company-service.test.ts
├── components/
│   ├── organisms/
│   │   ├── CompanyTable/       # Main data grid
│   │   ├── CompanyForm/        # Add/Edit form
│   │   ├── CompanyImport/      # CSV upload
│   │   ├── ConflictResolver/   # Sync conflict UI
│   │   └── HomeLocationSettings/ # Home address setup
│   └── molecular/
│       ├── CompanyRow/         # Table row
│       ├── CompanyFilters/     # Filter controls
│       ├── CompanyExport/      # Export buttons (CSV, JSON, GPX, Print)
│       └── CoordinateMap/      # Map verification component
└── app/
    └── companies/
        └── page.tsx            # Protected page
```

**Structure Decision**: Web application pattern with Next.js App Router. Components follow atomic design (molecular/organisms). Services in `src/lib/companies/`.

## Implementation Phases

### Phase 1: Foundation (Database + Types)

- Add `companies` table to monolithic migration
- Add home location fields to `user_profiles`
- Create TypeScript type definitions
- Execute schema via Supabase Management API

### Phase 2: Service Layer

- Implement geocoding service with Nominatim
- Implement IndexedDB offline store
- Implement sync queue and conflict detection
- Implement company service with CRUD operations
- Write unit tests for all services

### Phase 3: Components

- Generate components using `pnpm run generate:component`
- Implement CoordinateMap for visual coordinate verification (Leaflet)
- Implement CompanyTable with sorting/filtering
- Implement CompanyForm with validation + geocoding + map preview
- Implement CompanyFilters for status/priority/route (AND logic)
- Implement CompanyImport with CSV parsing
- Implement CompanyExport for CSV/JSON/GPX/Printable export
- Implement ConflictResolver for sync conflicts
- Implement HomeLocationSettings for home address setup
- Write component tests and Storybook stories

### Phase 4: Integration

- Create `/companies` page with auth protection
- Integrate with navigation/sidebar
- Add OSM attribution to footer
- Wire up offline sync on network events

### Phase 5: Testing & Polish

- E2E tests for full user flows
- Accessibility testing (Pa11y)
- Performance testing with 100+ companies
- Edge case testing (offline, conflicts, import errors)

## Key Technical Decisions

| Decision            | Choice                | Rationale                                   |
| ------------------- | --------------------- | ------------------------------------------- |
| Geocoding           | Nominatim             | Free, no API key, static-hosting compatible |
| Map Display         | Leaflet + OSM tiles   | Free, offline-cacheable, matches Nominatim  |
| Offline Storage     | IndexedDB             | Native browser API, no dependencies         |
| Conflict Resolution | User choice           | Per clarification - prompt to choose        |
| Uniqueness          | Name + Address        | Same company at multiple locations OK       |
| Home Location       | Profile settings      | One-time setup for distance validation      |
| Data Limit          | Unlimited             | IndexedDB can handle thousands              |
| Export Formats      | CSV, JSON, GPX, Print | Constitution §XI compliance                 |
| Distance Threshold  | 20 miles default      | User-configurable 1-100 miles               |

## Dependencies

- **Internal**: AuthContext, Supabase client, Footer component
- **External**: Nominatim API (free, rate-limited)
- **New packages**: None required (use native IndexedDB)

## Risks & Mitigations

| Risk               | Impact | Mitigation                             |
| ------------------ | ------ | -------------------------------------- |
| Nominatim downtime | Med    | Graceful fallback to manual entry      |
| IndexedDB quota    | Low    | Monitor storage, warn if low           |
| Sync conflicts     | Med    | Clear UI for resolution                |
| Large imports      | Low    | Progress indicator, chunked processing |

## Success Metrics

From spec.md Success Criteria:

- SC-001: Add company in <60 seconds ✓
- SC-002: Find company in <10 seconds (100+ records) ✓
- SC-003: Geocoding 90%+ success for US addresses ✓
- SC-004: Data persists across sessions ✓
- SC-005: Import 50 companies in <30 seconds ✓
- SC-006: Round-trip export/import without data loss ✓

## Next Steps

1. Run `/checklist` to validate requirements quality
2. Run `/tasks` to generate implementation tasks
3. Run `/analyze` for cross-artifact consistency check
4. Run `/implement` to begin implementation
