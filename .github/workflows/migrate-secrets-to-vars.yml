name: Migrate Secrets to Variables (one-time)

# Manual trigger only - run once then delete this file
on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Migrate secrets to variables
        env:
          GH_TOKEN: ${{ secrets.MIGRATION_PAT }}
          REPO: ${{ github.repository }}
          # --- Non-sensitive values to migrate ---
          S_ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          S_NEXT_PUBLIC_ADMIN_USER_ID: ${{ secrets.NEXT_PUBLIC_ADMIN_USER_ID }}
          S_NEXT_PUBLIC_AUTHOR_BIO: ${{ secrets.NEXT_PUBLIC_AUTHOR_BIO }}
          S_NEXT_PUBLIC_AUTHOR_EMAIL: ${{ secrets.NEXT_PUBLIC_AUTHOR_EMAIL }}
          S_NEXT_PUBLIC_AUTHOR_GITHUB: ${{ secrets.NEXT_PUBLIC_AUTHOR_GITHUB }}
          S_NEXT_PUBLIC_AUTHOR_LINKEDIN: ${{ secrets.NEXT_PUBLIC_AUTHOR_LINKEDIN }}
          S_NEXT_PUBLIC_AUTHOR_NAME: ${{ secrets.NEXT_PUBLIC_AUTHOR_NAME }}
          S_NEXT_PUBLIC_AUTHOR_ROLE: ${{ secrets.NEXT_PUBLIC_AUTHOR_ROLE }}
          S_NEXT_PUBLIC_AUTHOR_WEBSITE: ${{ secrets.NEXT_PUBLIC_AUTHOR_WEBSITE }}
          S_NEXT_PUBLIC_BASE_URL: ${{ secrets.NEXT_PUBLIC_BASE_URL }}
          S_NEXT_PUBLIC_CALENDAR_URL: ${{ secrets.NEXT_PUBLIC_CALENDAR_URL }}
          S_NEXT_PUBLIC_DEPLOY_URL: ${{ secrets.NEXT_PUBLIC_DEPLOY_URL }}
          S_NEXT_PUBLIC_GA_MEASUREMENT_ID: ${{ secrets.NEXT_PUBLIC_GA_MEASUREMENT_ID }}
          S_NEXT_PUBLIC_GOOGLE_SITE_VERIFICATION: ${{ secrets.NEXT_PUBLIC_GOOGLE_SITE_VERIFICATION }}
          S_NEXT_PUBLIC_PROJECT_NAME: ${{ secrets.NEXT_PUBLIC_PROJECT_NAME }}
          S_NEXT_PUBLIC_PROJECT_OWNER: ${{ secrets.NEXT_PUBLIC_PROJECT_OWNER }}
          S_NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}
          S_SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          S_TEST_USER_PRIMARY_EMAIL: ${{ secrets.TEST_USER_PRIMARY_EMAIL }}
          S_TEST_USER_SECONDARY_EMAIL: ${{ secrets.TEST_USER_SECONDARY_EMAIL }}
          S_TEST_USER_TERTIARY_EMAIL: ${{ secrets.TEST_USER_TERTIARY_EMAIL }}
        run: |
          VARS=(
            "ADMIN_EMAIL:S_ADMIN_EMAIL"
            "NEXT_PUBLIC_ADMIN_USER_ID:S_NEXT_PUBLIC_ADMIN_USER_ID"
            "NEXT_PUBLIC_AUTHOR_BIO:S_NEXT_PUBLIC_AUTHOR_BIO"
            "NEXT_PUBLIC_AUTHOR_EMAIL:S_NEXT_PUBLIC_AUTHOR_EMAIL"
            "NEXT_PUBLIC_AUTHOR_GITHUB:S_NEXT_PUBLIC_AUTHOR_GITHUB"
            "NEXT_PUBLIC_AUTHOR_LINKEDIN:S_NEXT_PUBLIC_AUTHOR_LINKEDIN"
            "NEXT_PUBLIC_AUTHOR_NAME:S_NEXT_PUBLIC_AUTHOR_NAME"
            "NEXT_PUBLIC_AUTHOR_ROLE:S_NEXT_PUBLIC_AUTHOR_ROLE"
            "NEXT_PUBLIC_AUTHOR_WEBSITE:S_NEXT_PUBLIC_AUTHOR_WEBSITE"
            "NEXT_PUBLIC_BASE_URL:S_NEXT_PUBLIC_BASE_URL"
            "NEXT_PUBLIC_CALENDAR_URL:S_NEXT_PUBLIC_CALENDAR_URL"
            "NEXT_PUBLIC_DEPLOY_URL:S_NEXT_PUBLIC_DEPLOY_URL"
            "NEXT_PUBLIC_GA_MEASUREMENT_ID:S_NEXT_PUBLIC_GA_MEASUREMENT_ID"
            "NEXT_PUBLIC_GOOGLE_SITE_VERIFICATION:S_NEXT_PUBLIC_GOOGLE_SITE_VERIFICATION"
            "NEXT_PUBLIC_PROJECT_NAME:S_NEXT_PUBLIC_PROJECT_NAME"
            "NEXT_PUBLIC_PROJECT_OWNER:S_NEXT_PUBLIC_PROJECT_OWNER"
            "NEXT_PUBLIC_SITE_URL:S_NEXT_PUBLIC_SITE_URL"
            "SUPABASE_PROJECT_REF:S_SUPABASE_PROJECT_REF"
            "TEST_USER_PRIMARY_EMAIL:S_TEST_USER_PRIMARY_EMAIL"
            "TEST_USER_SECONDARY_EMAIL:S_TEST_USER_SECONDARY_EMAIL"
            "TEST_USER_TERTIARY_EMAIL:S_TEST_USER_TERTIARY_EMAIL"
          )

          SUCCESS=0
          SKIP=0
          FAIL=0

          for entry in "${VARS[@]}"; do
            VAR_NAME="${entry%%:*}"
            ENV_KEY="${entry##*:}"
            VALUE="${!ENV_KEY}"

            if [ -z "$VALUE" ]; then
              echo "SKIP: $VAR_NAME (secret is empty/unset)"
              SKIP=$((SKIP + 1))
              continue
            fi

            # Try update first (PATCH), fall back to create (POST)
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X PATCH \
              "https://api.github.com/repos/${REPO}/actions/variables/${VAR_NAME}" \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              -d "{\"value\":\"${VALUE}\"}")

            if [ "$HTTP_CODE" = "204" ]; then
              echo "UPDATED: $VAR_NAME"
              SUCCESS=$((SUCCESS + 1))
            elif [ "$HTTP_CODE" = "404" ]; then
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
                "https://api.github.com/repos/${REPO}/actions/variables" \
                -H "Authorization: Bearer ${GH_TOKEN}" \
                -H "Accept: application/vnd.github+json" \
                -d "{\"name\":\"${VAR_NAME}\",\"value\":\"${VALUE}\"}")

              if [ "$HTTP_CODE" = "201" ]; then
                echo "CREATED: $VAR_NAME"
                SUCCESS=$((SUCCESS + 1))
              else
                echo "FAIL: $VAR_NAME (create returned $HTTP_CODE)"
                FAIL=$((FAIL + 1))
              fi
            else
              echo "FAIL: $VAR_NAME (update returned $HTTP_CODE)"
              FAIL=$((FAIL + 1))
            fi
          done

          echo ""
          echo "=== Migration Summary ==="
          echo "Success: $SUCCESS"
          echo "Skipped: $SKIP"
          echo "Failed:  $FAIL"

          if [ "$FAIL" -gt 0 ]; then
            exit 1
          fi
